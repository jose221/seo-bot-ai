<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">
      <div class="d-flex flex-wrap gap-2 mb-4"><a class="btn btn-outline-primary d-flex flex-fill align-items-center gap-2 flex-sm-grow-0" role="button" href="#auditorias"> Auditorías </a><a class="btn btn-outline-primary d-flex flex-fill align-items-center gap-2 flex-sm-grow-0" role="button" href="#sitios"> Listado de Sitios </a></div>
      <div class="card rounded-3 border-0 shadow-sm">
        <div class="card-body p-4 p-md-5">
          <div class="text-center mb-4">
            <h2 class="fw-bold text-primary mb-2">Comparativa de Páginas Web</h2>
            <p class="text-muted">Seleccione una página web base y las páginas con las que desea compararla</p>
          </div>
          <form id="compareForm" class="needs-validation" [formGroup]="form" (ngSubmit)="onSubmit()">
            <div class="mb-4">
              <label class="form-label fw-semibold" for="baseWebPage">
                Página Web Base <span class="text-danger">*</span>
            </label>
              <select
                class="border-2 form-select form-select-lg form-select"
                id="baseWebPage"
                formControlName="web_page_id"
                aria-describedby="validationBaseWebPage"
                [ngClass]="{'is-invalid': messages('web_page_id').length > 0}"
              >
              <option value="" disabled>Seleccione una página web...</option>
              @for (audit of targetSearchList(); track audit.id){
                <option [value]="audit.id">{{audit.name}} ({{audit.url}})</option>
              }
            </select>
              @if(messages('web_page_id').length > 0){
                @for(msg of messages('web_page_id'); track msg){
                  <div id="validationWebPageId" class="invalid-feedback">
                    {{msg}}
                  </div>
                }
              } @else {
                <div class="form-text"><span>Seleccione la página web que será la base de la comparación</span></div>
              }

            </div>
            <div class="mb-4"><label class="form-label fw-semibold">Páginas Web para Comparar <span class="text-danger">*</span></label>

              <!-- Filtros -->
              <div class="row g-2 mb-3">
                <div class="col-md-6">
                  <label class="form-label small">Buscar página</label>
                  <input type="text"
                         class="form-control form-control-sm"
                         placeholder="Buscar por nombre o URL..."
                         [ngModel]="formTargetSearchListToCompare().query"
                         (ngModelChange)="updateQuery($event)"
                         [ngModelOptions]="{standalone: true}">
                </div>
              </div>

              <div class="bg-light border rounded-3 p-3">
                <div class="mb-3 form-text"><span>Seleccione una o más páginas web para comparar con la base</span></div>

                @if (loadingCompareList()) {
                  <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="text-muted mt-2 mb-0">Buscando páginas...</p>
                  </div>
                } @else if (targetSearchListToCompare().length === 0) {
                  <div class="text-center py-4">
                    <svg class="bi bi-inbox mb-3 text-muted" fill="currentColor" height="48" viewBox="0 0 16 16" width="48" xmlns="http://www.w3.org/2000/svg">
                      <path d="M4.98 4a.5.5 0 0 0-.39.188L1.54 8H6a.5.5 0 0 1 .5.5 1.5 1.5 0 1 0 3 0A.5.5 0 0 1 10 8h4.46l-3.05-3.812A.5.5 0 0 0 11.02 4zm9.954 5H10.45a2.5 2.5 0 0 1-4.9 0H1.066l.32 2.562a.5.5 0 0 0 .497.438h12.234a.5.5 0 0 0 .496-.438zM3.809 3.563A1.5 1.5 0 0 1 4.981 3h6.038a1.5 1.5 0 0 1 1.172.563l3.7 4.625a.5.5 0 0 1 .105.374l-.39 3.124A1.5 1.5 0 0 1 14.117 13H1.883a1.5 1.5 0 0 1-1.489-1.314l-.39-3.124a.5.5 0 0 1 .106-.374z"/>
                    </svg>
                    <p class="text-muted mb-0">No se encontraron páginas para comparar</p>
                    <small class="text-muted">Intenta ajustar los filtros de búsqueda</small>
                  </div>
                } @else {
                  @for (audit of targetSearchListToCompare(); track audit.id){
                    <div class="mb-3 form-check">
                      <input type="checkbox"
                             class="form-check-input"
                             [id]="'compare-' + audit.id"
                             [checked]="isPageSelected(audit.id)"
                             (change)="onComparePageChange(audit.id, $event)">
                      <label class="form-check-label text-truncate d-block"
                             [for]="'compare-' + audit.id"
                             [title]="audit.name + ' (' + audit.url + ')'">
                        {{audit.name}} ({{audit.url}})
                      </label>
                    </div>
                  }
                }
              </div>
              @if (submitted() && form.get('web_page_id_compare')?.invalid) {
                <div class="d-block invalid-feedback">
                  <span>Por favor seleccione al menos una página para comparar.</span>
                </div>
              }
            </div>
            <div class="mb-4">
              <div class="form-check form-switch">
                <input type="checkbox"
                       class="form-check-input"
                       id="includeAiAnalysis"
                       formControlName="include_ai_analysis">
                <label class="fw-semibold form-check-label" for="includeAiAnalysis">
                  Incluir Análisis con IA
                </label>
              </div>
              <div class="form-text"><span>Active esta opción para obtener recomendaciones generadas por inteligencia artificial</span></div>
            </div>
            <div class="d-grid d-md-flex gap-2 justify-content-md-end mt-5"><button class="btn btn-outline-secondary btn-lg px-4" type="reset"> Limpiar </button><button class="btn btn-primary btn-lg shadow-sm px-5" type="submit"> Generar Comparativa </button></div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<app-default-modal classModalDialog="modal-xl" [expanded]="true">
  <app-header-modal classModal=" text-white bg-primary">
    <h5 class="fw-bold modal-title" id="resultsModalLabel">
      Resultados de la Comparativa
    </h5>
    <button class="btn-close btn-close-white" aria-label="Close" (click)="showMessageConfirmation.set(false)" type="button"></button>
  </app-header-modal>
  <app-body-modal>
    <div class="mb-4">
      <h6 class="fw-bold text-primary">Página Web Base</h6>
      <p class="mb-0">
        <a class="text-decoration-none" href="https://example.com" target="_blank">
          {{ responseCompareAudit()?.base_url }}
        </a>
      </p>
    </div>
    <div class="alert alert-info border-0 shadow-sm mb-4" role="alert">
      <h6 class="fw-bold mb-2">
        <svg class="bi bi-robot me-2" fill="currentColor" height="20" viewbox="0 0 16 16" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5M3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.6 26.6 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.93.93 0 0 1-.765.935c-.845.147-2.34.346-4.235.346s-3.39-.2-4.235-.346A.93.93 0 0 1 3 9.219zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a25 25 0 0 1-1.871-.183.25.25 0 0 0-.068.495c.55.076 1.232.149 2.02.193a.25.25 0 0 0 .189-.071l.754-.736.847 1.71a.25.25 0 0 0 .404.062l.932-.97a25 25 0 0 0 1.922-.188.25.25 0 0 0-.068-.495c-.538.074-1.207.145-1.98.189a.25.25 0 0 0-.166.076l-.754.785-.842-1.7a.25.25 0 0 0-.182-.135"></path><path d="M8.5 1.866a1 1 0 1 0-1 0V3h-2A4.5 4.5 0 0 0 1 7.5V8a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1v1a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-1a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1v-.5A4.5 4.5 0 0 0 10.5 3h-2zM14 7.5V13a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V7.5A3.5 3.5 0 0 1 5.5 4h5A3.5 3.5 0 0 1 14 7.5"></path></svg>
        Análisis con IA
      </h6>
      <p class="mb-0">
        {{ responseCompareAudit()?.ai_schema_comparison }}
      </p>
    </div>
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white border-0 pt-3">
        <h6 class="fw-bold text-primary mb-0">Resumen General</h6>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <div class="bg-light rounded-3 p-3"><small class="text-muted d-block mb-1">
              Mejor en Rendimiento</small>
              <span class="badge bg-success">
                {{responseCompareAudit()?.overall_summary?.best_in_performance}}
              </span>
            </div>
          </div>
          <div class="col-md-4">
            <div class="bg-light rounded-3 p-3">
              <small class="text-muted d-block mb-1">
                Mejor en SEO
              </small>
              <span class="badge bg-warning text-dark">
                {{responseCompareAudit()?.overall_summary?.best_in_seo}}
              </span>
            </div>
          </div>
          <div class="col-md-4">
            <div class="bg-light rounded-3 p-3">
              <small class="text-muted d-block mb-1">
              Áreas a Mejorar
              </small>
              @for (area_to_improve of responseCompareAudit().overall_summary?.areas_to_improve; track area_to_improve){
                <span class="badge bg-danger me-1">
                  {{area_to_improve}}
                </span>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
    <h6 class="fw-bold text-primary mb-3">Comparaciones Detalladas</h6>
    <div class="accordion" role="tablist" id="comparisonsAccordion">
      @for (comparison of responseCompareAudit().comparisons; track comparison.compare_url){
        <div class="accordion-item border-0 shadow-sm mb-3">
          <h2 class="accordion-header" role="tab" id="heading1">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1" aria-expanded="true" aria-controls="collapse1">
              <div class="d-flex align-items-center justify-content-between w-100 pe-3">
                <span class="fw-semibold">
                  {{comparison.compare_url}}
                </span>
                <span class="badge bg-success">
                  Ganador: {{comparison.summary.overall_winner}}
                </span>
              </div>
            </button>
          </h2>
          <div class="accordion-collapse collapse show item-1 show" role="tabpanel" data-bs-parent="#comparisonsAccordion" aria-labelledby="heading1" id="collapse1">
            <div class="accordion-body">
              <h6 class="fw-bold mb-3">Recomendaciones</h6>
              <div class="list-group">
                @for (recommendation of comparison.recommendations; track recommendation){
                  <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                      <h6 class="mb-1">
                        {{recommendation.title}}
                      </h6>
                      <span class="badge bg-danger">
                        {{recommendation.priority}}
                      </span>
                    </div>
                    <small class="text-muted">
                      Categoría: {{recommendation.category}}
                    </small>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      }
    </div>

  </app-body-modal>
  <app-footer-modal>
    <button class="btn btn-secondary" type="button" (click)="showMessageConfirmation.set(false)">
      Cerrar
    </button>
    <button class="btn btn-primary" type="button">Exportar Reporte</button>
  </app-footer-modal>
</app-default-modal>
