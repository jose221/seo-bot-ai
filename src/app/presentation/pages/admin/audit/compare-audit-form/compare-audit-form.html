<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">
      <div class="d-flex flex-wrap gap-2 mb-4">
        <a class="btn btn-outline-primary d-flex flex-fill align-items-center gap-2 flex-sm-grow-0" role="button" routerLink="/admin/audit">
          {{ 'audits.compare.buttons.audits' | translate }}
        </a>
        <a class="btn btn-outline-primary d-flex flex-fill align-items-center gap-2 flex-sm-grow-0" role="button" routerLink="/admin/target">
          {{ 'audits.compare.buttons.sites' | translate }}
        </a>
        <a class="btn btn-outline-primary d-flex flex-fill align-items-center gap-2 flex-sm-grow-0" role="button" routerLink="/admin/audit/comparisons">
          {{ 'audits.compare.buttons.sites_compare' | translate }}
        </a>
      </div>
      <div class="card rounded-3 border-0 shadow-sm">
        <div class="card-body p-4 p-md-5">
          <div class="text-center mb-4">
            <h2 class="fw-bold text-primary mb-2">{{ 'audits.compare.title' | translate }}</h2>
            <p class="text-muted">{{ 'audits.compare.subtitle' | translate }}</p>
          </div>
          <form id="compareForm" class="needs-validation" [formGroup]="form" (ngSubmit)="onSubmit()">
            <div class="mb-4">
              <label class="form-label fw-semibold" for="baseWebPage">
                {{ 'audits.compare.basePage.label' | translate }} <span class="text-danger">*</span>
            </label>
              <select
                class="border-2 form-select form-select-lg form-select"
                id="baseWebPage"
                formControlName="web_page_id"
                aria-describedby="validationBaseWebPage"
                [ngClass]="{'is-invalid': messages('web_page_id').length > 0}"
              >
              <option value="" disabled>{{ 'audits.compare.basePage.placeholder' | translate }}</option>
              @for (audit of targetSearchList(); track audit.id){
                <option [value]="audit.id">{{audit.name}} ({{audit.url}})</option>
              }
            </select>
              @if(messages('web_page_id').length > 0){
                @for(msg of messages('web_page_id'); track msg){
                  <div id="validationWebPageId" class="invalid-feedback">
                    {{msg}}
                  </div>
                }
              } @else {
                <div class="form-text"><span>{{ 'audits.compare.basePage.help' | translate }}</span></div>
              }

            </div>
            <div class="mb-4"><label class="form-label fw-semibold">{{ 'audits.compare.comparePages.label' | translate }} <span class="text-danger">*</span></label>

              <!-- Filtros -->
              <div class="row g-2 mb-3">
                <div class="col-md-6">
                  <label class="form-label small">{{ 'audits.compare.filters.searchPage' | translate }}</label>
                  <input type="text"
                         class="form-control form-control-sm"
                         [placeholder]="'audits.compare.filters.searchPlaceholder' | translate"
                         [ngModel]="formTargetSearchListToCompare().query"
                         (ngModelChange)="updateQuery($event)"
                         [ngModelOptions]="{standalone: true}">
                </div>
              </div>

              <div class="bg-light border rounded-3 p-3">
                <div class="mb-3 form-text"><span>{{ 'audits.compare.comparePages.help' | translate }}</span></div>

                @if (loadingCompareList()) {
                  <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">{{ 'general.messages.loading' | translate }}</span>
                    </div>
                    <p class="text-muted mt-2 mb-0">{{ 'audits.compare.loading.searching' | translate }}</p>
                  </div>
                } @else if (targetSearchListToCompare().length === 0) {
                  <div class="text-center py-4">
                    <svg class="bi bi-inbox mb-3 text-muted" fill="currentColor" height="48" viewBox="0 0 16 16" width="48" xmlns="http://www.w3.org/2000/svg">
                      <path d="M4.98 4a.5.5 0 0 0-.39.188L1.54 8H6a.5.5 0 0 1 .5.5 1.5 1.5 0 1 0 3 0A.5.5 0 0 1 10 8h4.46l-3.05-3.812A.5.5 0 0 0 11.02 4zm9.954 5H10.45a2.5 2.5 0 0 1-4.9 0H1.066l.32 2.562a.5.5 0 0 0 .497.438h12.234a.5.5 0 0 0 .496-.438zM3.809 3.563A1.5 1.5 0 0 1 4.981 3h6.038a1.5 1.5 0 0 1 1.172.563l3.7 4.625a.5.5 0 0 1 .105.374l-.39 3.124A1.5 1.5 0 0 1 14.117 13H1.883a1.5 1.5 0 0 1-1.489-1.314l-.39-3.124a.5.5 0 0 1 .106-.374z"/>
                    </svg>
                    <p class="text-muted mb-0">{{ 'audits.compare.noResults.title' | translate }}</p>
                    <small class="text-muted">{{ 'audits.compare.noResults.subtitle' | translate }}</small>
                  </div>
                } @else {
                  @for (audit of targetSearchListToCompare(); track audit.id){
                    <div class="mb-3 form-check">
                      <input type="checkbox"
                             class="form-check-input"
                             [id]="'compare-' + audit.id"
                             [checked]="isPageSelected(audit.id)"
                             (change)="onComparePageChange(audit.id, $event)">
                      <label class="form-check-label text-truncate d-block"
                             [for]="'compare-' + audit.id"
                             [title]="audit.name + ' (' + audit.url + ')'">
                        {{audit.name}} ({{audit.url}})
                      </label>
                    </div>
                  }
                }
              </div>
              @if (submitted() && form.get('web_page_id_to_compare')?.invalid) {
                <div class="d-block invalid-feedback">
                  <span>{{ 'audits.compare.comparePages.required' | translate }}</span>
                </div>
              }
            </div>
            <div class="mb-4">
              <div class="form-check form-switch">
                <input type="checkbox"
                       class="form-check-input"
                       id="includeAiAnalysis"
                       formControlName="include_ai_analysis">
                <label class="fw-semibold form-check-label" for="includeAiAnalysis">
                  {{ 'audits.compare.includeAI.label' | translate }}
                </label>
              </div>
              <div class="form-text"><span>{{ 'audits.compare.includeAI.help' | translate }}</span></div>
            </div>
            <div class="d-grid d-md-flex gap-2 justify-content-md-end mt-5">
              <button class="btn btn-outline-secondary btn-lg px-4" type="reset">
                {{ 'general.actions.clear' | translate }}
              </button>
              <button class="btn btn-primary btn-lg shadow-sm px-5" type="submit">
                {{ 'audits.compare.buttons.compare' | translate }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<app-default-modal [expanded]="showMessageConfirmation()">
  <app-header-modal>
    <h5 class="text-primary modal-title" id="responseModalLabel">
      <i class="me-2 bi bi-check-circle-fill"></i>
      {{ 'audits.form.confirmModal.title' | translate }}
    </h5>
    <button class="btn-close" aria-label="Close" (click)="showMessageConfirmation.set(false)" type="button"></button>
  </app-header-modal>

  <app-body-modal>
    <div class="alert alert-info mb-3" role="alert">
      <strong>{{ 'audits.form.confirmModal.message' | translate }} </strong>
      <span id="modalMessage"> {{responseCompareAudit().message}}</span>
    </div>
    <div class="mb-2">
      <strong>{{ 'audits.form.confirmModal.status' | translate }} </strong>
      <span class="badge bg-warning text-dark" id="modalStatus"> {{statusAuditUtil.getStatusText(responseCompareAudit().status)}}</span>
    </div>
    <div class="mb-2">
      <strong>{{ 'audits.form.confirmModal.taskId' | translate }} </strong>
      <code id="modalTaskId"> {{responseCompareAudit().task_id}}</code>
    </div>
  </app-body-modal>
  <app-footer-modal>
    <button class="btn btn-secondary" (click)="showMessageConfirmation.set(false)" type="button">{{ 'audits.form.confirmModal.acceptButton' | translate }}</button>
    <a class="btn btn-primary" id="viewAuditsBtn" routerLink="/admin/audit">
      <i class="me-1 bi bi-list-check"></i>{{ 'audits.form.confirmModal.viewListButton' | translate }}
    </a>
  </app-footer-modal>

</app-default-modal>

