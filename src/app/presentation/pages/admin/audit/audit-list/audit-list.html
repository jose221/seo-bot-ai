<div class="row mb-5">
  <div class="col-12 text-center">
    <h1 class="display-4 fw-light mb-2"><i class="text-primary bi bi-globe2"></i> {{ 'audits.title' | translate }}</h1>
    <p class="fs-6 text-muted">{{ 'audits.subtitle' | translate }}</p>
  </div>
</div>
<div class="row mb-4">
  <div class="col-12 mx-auto">
    <div class="card rounded-3 border-0 shadow-sm">
      <div class="card-body p-4">
        @if (!isLoading() && cItems().data.length > 0) {
          <div class="row align-items-center g-3">
            <div class="col-12 col-lg-8">
              <app-filter-list class="w-100" [data]="cItems()" (dataChange)="items.set($event)" [config]="configFilter()" ></app-filter-list>
            </div>
            <div class="col-12 col-lg-4">
              <div class="d-flex gap-2">
                <a class="btn btn-primary rounded-2 flex-fill" routerLink="/admin/audit/create">
                  <i class="me-1 bi bi-plus-circle"></i> {{ 'audits.buttons.new' | translate }}
                </a>
                <a class="btn btn-outline-secondary rounded-2 flex-fill" routerLink="/admin/target">
                  <i class="me-1 bi bi-clipboard-check"></i>{{ 'audits.buttons.pages' | translate }}
                </a>
              </div>
            </div>
          </div>
        }
        <div class="row mt-4">
          @if (!isLoading() && items().data.length > 0){
            <app-table [data]="items()" [labels]="tableColumn()"></app-table>
            <div  class="mt-5" >
              <app-paginator-list [data]="items()" (dataChange)="items.set($event)"></app-paginator-list>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>

<app-default-modal classModalDialog="modal-xl" [expanded]="showItem()?.id != null">
  <app-header-modal classModal="bg-gradient border-0 py-3 bg-primary">
    <div>
      <h5 class="fw-bold text-white modal-title" id="reportModalLabel">
        <i class="me-2 bi bi-file-earmark-text"></i>{{ 'audits.modal.title' | translate }}
      </h5>
      <p class="text-white-50 mt-1 mb-0 small">ID: {{showItem()?.id}}</p>
    </div>
    <button class="btn-close btn-close-white" [attr.aria-label]="'general.actions.close' | translate" (click)="showItem.set(null)" type="button"></button>
  </app-header-modal>
  <app-body-modal>
    <div class="row g-4">
      @if (showItem()?.error_message) {
        <div class="col-12">
          <div class="alert alert-danger border-0 shadow-sm d-flex align-items-center" role="alert">
            <i class="fs-4 me-3 bi bi-exclamation-triangle-fill"></i>
            <div>
              <h6 class="mb-1 alert-heading">{{ 'audits.modal.error.title' | translate }}</h6>
              <p class="mb-0">{{showItem()?.error_message}}</p>
            </div>
          </div>
        </div>
      }
      <div class="col-md-6">
        <div class="card h-100 bg-light border-0">
          <div class="card-body">
            <h6 class="fw-semibold text-muted mb-3 card-subtitle">
              <i class="me-2 bi bi-info-circle"></i>{{ 'audits.modal.generalInfo.title' | translate }}
            </h6>
            <ul class="list-unstyled mb-0">
              <li class="d-flex justify-content-between mb-2">
                <span class="text-muted">{{ 'audits.modal.generalInfo.status' | translate }}:</span>
                <span class="badge px-3 py-2" [ngClass]="[statusAuditUtil.getStatusClass(showItem()?.status ?? '')]">
                  {{statusAuditUtil.getStatusText(showItem()?.status)}}
                </span>
              </li>
              <li class="d-flex justify-content-between mb-2">
                <span class="text-muted">{{ 'audits.modal.generalInfo.createdDate' | translate }}:</span>
                <strong>{{showItem()?.created_at | dateFormat:'short': 'es': true}}</strong>
              </li>
              <li class="d-flex justify-content-between mb-2">
                <span class="text-muted">{{ 'audits.modal.generalInfo.finishedDate' | translate }}:</span>
                <strong>{{showItem()?.completed_at | dateFormat:'short': 'es': true}}</strong>
              </li>
              <li class="d-flex justify-content-between mb-2">
                <span class="text-muted">{{ 'audits.modal.generalInfo.webPageId' | translate }}:</span>
                <small class="font-monospace">{{showItem()?.web_page_id}}</small>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card h-100 bg-light border-0">
          <div class="card-body">
            <h6 class="fw-semibold text-muted mb-3 card-subtitle">
              <i class="me-2 bi bi-speedometer2"></i>{{ 'audits.modal.metrics.title' | translate }}
            </h6>
            <div class="row g-3">
              <div class="col-6">
                <div class="text-center bg-white rounded p-3">
                  <div class="text-muted mb-1 small"><span>{{ 'audits.modal.metrics.performance' | translate }}</span></div>
                  <div class="fs-5 fw-bold text-muted">
                    <span>
                      @if (showItem()?.performance_score) {
                        {{showItem()?.performance_score}}
                      } @else {
                        {{ 'audits.modal.metrics.na' | translate }}
                      }
                    </span>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="text-center bg-white rounded p-3">
                  <div class="text-muted mb-1 small"><span>{{ 'audits.modal.metrics.seo' | translate }}</span></div>
                  <div class="fs-5 fw-bold text-muted">
                  <span>
                      @if (showItem()?.seo_score) {
                        {{showItem()?.seo_score}}
                      } @else {
                        {{ 'audits.modal.metrics.na' | translate }}
                      }
                    </span>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="text-center bg-white rounded p-3">
                  <div class="text-muted mb-1 small"><span>{{ 'audits.modal.metrics.accessibility' | translate }}</span></div>
                  <div class="fs-5 fw-bold text-muted">
                    <span>
                      @if (showItem()?.accessibility_score) {
                        {{showItem()?.accessibility_score}}
                      } @else {
                        {{ 'audits.modal.metrics.na' | translate }}
                      }
                    </span>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="text-center bg-white rounded p-3">
                  <div class="text-muted mb-1 small"><span>{{ 'audits.modal.metrics.bestPractices' | translate }}</span></div>
                  <div class="fs-5 fw-bold text-muted">
                    <span>
                      @if (showItem()?.best_practices_score) {
                        {{showItem()?.best_practices_score}}
                      } @else {
                        {{ 'audits.modal.metrics.na' | translate }}
                      }
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-0 py-3">
            <h6 class="fw-semibold mb-0">
              <i class="text-primary me-2 bi bi-clipboard-data"></i>{{ 'audits.modal.lighthouse.title' | translate }}
            </h6>
          </div>
          <div class="card-body">
            @if (showItem()?.lighthouse_data) {
              <div class="row g-4">
                <!-- URL y Método -->
                <div class="col-12">
                  <div class="p-3 bg-light rounded">
                    <div class="row align-items-center">
                      <div class="col-md-8">
                        <small class="text-muted d-block mb-1">URL Analizada</small>
                        <div class="d-flex align-items-center">
                          <i class="bi bi-link-45deg text-primary me-2"></i>
                          <a [href]="showItem()?.lighthouse_data?.url" target="_blank" class="text-truncate">
                            {{showItem()?.lighthouse_data?.url}}
                          </a>
                        </div>
                      </div>
                      <div class="col-md-4 text-md-end mt-2 mt-md-0">
                        <small class="text-muted d-block mb-1">Método</small>
                        <span class="badge bg-info">{{showItem()?.lighthouse_data?.method}}</span>
                        @if (showItem()?.lighthouse_data?.status_code) {
                          <span class="badge ms-2" [ngClass]="showItem()?.lighthouse_data?.status_code === 200 ? 'bg-success' : 'bg-danger'">
                            HTTP {{showItem()?.lighthouse_data?.status_code}}
                          </span>
                        }
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Core Web Vitals -->
                @if (showItem()?.lighthouse_data?.cls !== null || showItem()?.lighthouse_data?.lcp !== null) {
                  <div class="col-12">
                    <h6 class="fw-semibold mb-3">
                      <i class="bi bi-activity text-danger me-2"></i>Core Web Vitals
                    </h6>
                    <div class="row g-3">
                      @if (showItem()?.lighthouse_data?.lcp !== null) {
                        <div class="col-md-4">
                          <div class="p-3 border rounded">
                            <small class="text-muted d-block mb-1">LCP (Largest Contentful Paint)</small>
                            <div class="fw-bold">{{showItem()?.lighthouse_data?.lcp}}s</div>
                          </div>
                        </div>
                      }
                      @if (showItem()?.lighthouse_data?.cls !== null) {
                        <div class="col-md-4">
                          <div class="p-3 border rounded">
                            <small class="text-muted d-block mb-1">CLS (Cumulative Layout Shift)</small>
                            <div class="fw-bold">{{showItem()?.lighthouse_data?.cls}}</div>
                          </div>
                        </div>
                      }
                      @if (showItem()?.lighthouse_data?.fid !== null) {
                        <div class="col-md-4">
                          <div class="p-3 border rounded">
                            <small class="text-muted d-block mb-1">FID (First Input Delay)</small>
                            <div class="fw-bold">{{showItem()?.lighthouse_data?.fid}}ms</div>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }

                <!-- Análisis SEO -->
                @if (showItem()?.lighthouse_data?.seo_analysis) {
                  <div class="col-12">
                    <h6 class="fw-semibold mb-3">
                      <i class="bi bi-search text-success me-2"></i>Análisis SEO
                    </h6>
                    <div class="card border-0 bg-light">
                      <div class="card-body">
                        <div class="row g-3">
                          @if (showItem()?.lighthouse_data?.seo_analysis?.title) {
                            <div class="col-12">
                              <small class="text-muted d-block mb-1">
                                <i class="bi bi-type-h1 me-1"></i>{{ 'audits.modal.lighthouse.pageTitle' | translate }}
                              </small>
                              <div class="fw-semibold">{{showItem()?.lighthouse_data?.seo_analysis?.title}}</div>
                            </div>
                          }
                          @if (showItem()?.lighthouse_data?.seo_analysis?.metaDescription) {
                            <div class="col-12">
                              <small class="text-muted d-block mb-1">
                                <i class="bi bi-file-text me-1"></i>Meta Descripción
                              </small>
                              <div>{{showItem()?.lighthouse_data?.seo_analysis?.metaDescription}}</div>
                            </div>
                          }
                          <div class="col-12">
                            <div class="row g-2">
                              @if (showItem()?.lighthouse_data?.seo_analysis?.h1Count !== undefined) {
                                <div class="col-6 col-md-3">
                                  <div class="p-2 bg-white rounded text-center">
                                    <div class="fw-bold text-primary">{{showItem()?.lighthouse_data?.seo_analysis?.h1Count}}</div>
                                    <small class="text-muted">H1 Tags</small>
                                  </div>
                                </div>
                              }
                              @if (showItem()?.lighthouse_data?.seo_analysis?.imageCount !== undefined) {
                                <div class="col-6 col-md-3">
                                  <div class="p-2 bg-white rounded text-center">
                                    <div class="fw-bold text-primary">{{showItem()?.lighthouse_data?.seo_analysis?.imageCount}}</div>
                                    <small class="text-muted">Imágenes</small>
                                  </div>
                                </div>
                              }
                              @if (showItem()?.lighthouse_data?.seo_analysis?.imagesWithoutAlt !== undefined) {
                                <div class="col-6 col-md-3">
                                  <div class="p-2 bg-white rounded text-center">
                                    <div class="fw-bold" [ngClass]="showItem()?.lighthouse_data?.seo_analysis?.imagesWithoutAlt > 0 ? 'text-danger' : 'text-success'">
                                      {{showItem()?.lighthouse_data?.seo_analysis?.imagesWithoutAlt}}
                                    </div>
                                    <small class="text-muted">Sin Alt</small>
                                  </div>
                                </div>
                              }
                              @if (showItem()?.lighthouse_data?.seo_analysis?.linksCount !== undefined) {
                                <div class="col-6 col-md-3">
                                  <div class="p-2 bg-white rounded text-center">
                                    <div class="fw-bold text-primary">{{showItem()?.lighthouse_data?.seo_analysis?.linksCount}}</div>
                                    <small class="text-muted">Enlaces</small>
                                  </div>
                                </div>
                              }
                            </div>
                          </div>
                          <div class="col-12">
                            <div class="d-flex gap-2 flex-wrap">
                              @if (showItem()?.lighthouse_data?.seo_analysis?.hasViewport) {
                                <span class="badge bg-success">
                                  <i class="bi bi-check-circle me-1"></i>Viewport Meta
                                </span>
                              }
                              @if (showItem()?.lighthouse_data?.seo_analysis?.hasCanonical) {
                                <span class="badge bg-success">
                                  <i class="bi bi-check-circle me-1"></i>{{ 'audits.modal.lighthouse.canonicalTag' | translate }}
                                </span>
                              }
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                }


                <!-- Timestamp -->
                @if (showItem()?.lighthouse_data?.timestamp) {
                  <div class="col-12">
                    <small class="text-muted">
                      <i class="bi bi-clock me-1"></i>
                      {{ 'audits.modal.lighthouse.analysisPerformed' | translate }}: {{showItem()?.lighthouse_data?.timestamp | dateFormat:'short': 'es': true}}
                    </small>
                  </div>
                }
              </div>
            } @else {
              <div class="alert alert-secondary mb-0" role="alert">
                <i class="me-2 bi bi-info-circle"></i><span> {{ 'audits.modal.lighthouse.noData' | translate }} </span>
              </div>
            }
          </div>
        </div>
      </div>
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-0 py-3">
            <h6 class="fw-semibold mb-0">
              <i class="text-success me-2 bi bi-robot"></i>{{ 'audits.modal.ai.title' | translate }}
            </h6>
          </div>
          <div class="card-body">
            <div class="alert alert-light border-0 shadow-sm mb-4" role="alert">
              @if (showItem()?.ai_suggestions) {
                <div class="ai-content" style="max-height: 800px; overflow-y: auto;">
                  <div class="small" style="white-space: pre-line;">
                    <markdown [data]="showItem()?.ai_suggestions?.analysis"></markdown>
                  </div>
                </div>
              } @else {
                <i class="me-2 bi bi-info-circle"></i><span> {{ 'audits.modal.ai.noData' | translate }} </span>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </app-body-modal>
  <app-footer-modal>
    <button class="btn btn-secondary rounded-pill px-4" (click)="showItem.set({})" type="button">
      <i class="me-2 bi bi-x-circle"></i>{{ 'audits.modal.buttons.close' | translate }}
    </button>
    <button class="btn btn-primary rounded-pill px-4" type="button">
      <i class="me-2 bi bi-download"></i>{{ 'audits.modal.buttons.download' | translate }}
    </button>
  </app-footer-modal>
</app-default-modal>
